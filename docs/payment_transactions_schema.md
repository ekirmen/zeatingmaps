# Payment Transactions Table Overview

This document summarizes the `payment_transactions` table schema and its relationships, focusing on how transactions connect to users.

## Table Definition

The `payment_transactions` table stores payments associated with orders and events. Key fields include:

- `id`: Primary key (`uuid`) generated by `gen_random_uuid()`.
- `order_id`: External order identifier with a unique constraint.
- `status`: Transaction status (e.g., `completed`).
- `amount`/`currency`: Monetary amount and ISO currency code.
- `gateway_*`: Columns for payment gateway identifiers, names, and metadata.
- `funcion_id`, `evento_id`, `tenant_id`: References to functions, events, and tenants with foreign key enforcement.
- `seats`: JSONB payload that stores seat selections; several GIN/BTREE indexes optimize lookups.

## Relationship to Users

The table maintains multiple user-related columns:

- `user_id`: Foreign key to `profiles.id`, ensuring a direct, nullable link to the profile that initiated the transaction. This enforces referential integrity; deleting a profile sets `user_id` to `NULL` rather than removing the transaction.
- `user`: Additional nullable UUID column that is **not** constrained; it may mirror `user_id` but does not enforce referential integrity.
- `usuario_id`: Another nullable UUID without a foreign key, likely legacy. Consider standardizing on `user_id` for consistency.

Because `user_id` references `profiles(id)`, transactions can be associated with users when provided. The presence of unconstrained `user` and `usuario_id` fields means existing rows might lack a strict user link unless `user_id` is populated.

## Triggers

Several triggers maintain data consistency:

- `prevent_duplicate_purchases_trigger`: Prevents inserting or updating rows that would duplicate seat purchases.
- `tr_payment_transactions_set_updated_at`: Updates `updated_at` before each update.
- `trigger_crear_cuotas_pago`: Runs after insert when status is `completed` to create payment installments.
- `update_seat_locks_trigger`: Updates seat locks after inserts or updates to keep reservation state in sync.

## Indexes

Multiple BTREE and GIN indexes target frequent lookup paths, including:

- `funcion_id`, `tenant_id`, and `status` combinations for filtering by event function and tenancy.
- GIN indexes on `seats` for JSONB searches and seat-based constraints.
- User-centric indexes on `(user_id, created_at)` and `user_id` to speed up querying a user's transaction history.

## Example Row

An example `completed` payment illustrates typical values:

- `order_id`/`locator`: `T3WIBXV0`
- `funcion_id`/`funcion`: `43` tied to `evento_id` `b0b48dd8-7c52-462a-8c79-b00129422810`
- `amount`: `5.00` `USD` via `Pago MÃ³vil`
- `seats`: JSON with seat metadata (`mesa`, `zona`, `price`, and IDs)
- `user_id`: `NULL` (indicates the transaction is not linked to a profile)

This example shows that a transaction can exist without a user link when `user_id` is null.
